---
title: "Biome-Shiny HTML report"
output:
  html_document:
    code_folding: "hide"
    toc: true
    toc_float:
      toc_collapsed: true
    runtime: shiny
---

```{r, include=FALSE}
library(shiny)
library(plotly)
library(DT)
```


This is an HTML report generated by Biome-Shiny. It will generate an HTML file containing all **generated** plots and tables. Note that any plot whose variables have not been set by the user will use default variables.


## 1. Phyloseq File Summary

Basic information about the loaded dataset.

```{r, echo=FALSE}
  as.character(summarize_phyloseq_mod(datasetInput()))
```

```{r, echo=FALSE}
  as.character(list_sample_variables(datasetInput()))
```


## 2. Core Abundance Heatmap

Heatmap comparing abundance values for each OTU per sample.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  coreHeatmapParams()
```

## 3. Community Composition

### 3.1. Abundance Plot (Counts)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  communityPlotParams()
```

### 3.2. Abundance Plot (Relative)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  communityPlotGenusParams()
```

## 4. Alpha Diversity

Alpha diversity is an index that measures diversity within a sample.
To download the the tables in .csv format, use the download button from Biome-Shiny.

### 4.1. Evenness Table (Headers only)

Evenness measures how close, in numbers, each species is in the sample.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  datatable(head(as.data.frame(evenness(datasetInput()), options = list(scrollX = TRUE))))
```

Abundance can be measured either by the absolute number of a given species in the sample (counts) or by a ratio of the species relative to the total number of species in the sample (relative abundance).

### 4.2.Abundance Table (Counts)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  datatable(head(as.data.frame(abundances(datasetInput()), options = list(scrollX = TRUE))))
```

### 4.3. Abundance Table (Relative)

```{r, echo=FALSE, message=FALSE, warning=FALSE}
    datatable(head(as.data.frame(abundances(datasetInput(), transform = "compositional"), options = list(scrollX = TRUE))))
```

### 4.4. Diversity Measures Table

```{r, echo=FALSE, message=FALSE, warning=FALSE}
    datatable(head(as.data.frame(alpha(datasetInput()), options = list(scrollX = TRUE))))
```

### 4.5. Metadata Table

```{r, echo=FALSE, message=FALSE, warning=FALSE}
    datatable(head(as.data.frame(sample_data(datasetInput()), options = list(scrollX = TRUE))))
```

## 5. Beta Diversity

Beta diversity is the index that measures diversity between samples.

### 5.1. Sample Ordination Plot

Beta diversity PCA plots are used to measure diversity between samples based on their general microbial composition.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  ordinatePlotParams()
```

### 5.2. Taxa Ordination Plot

This plot also measures differences in composition, but between OTUs rather than samples.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  taxaOrdParams()
```

## 6. PERMANOVA test

### 6.1. PERMANOVA P-value and Homogeniety Tables ##

The PERMANOVA test can be used to determine the importance of a variable in affecting the samples' diversity. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  permanova()
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  homogenietyParams()
```

### 6.2. Top Factors Plot

A plot determining the OTUs which are most relevant for composition differences in samples.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  topFactorPlotParams <- reactive({
    otu <- abundances(compositionalInput())
    meta <- meta(compositionalInput())
    permnumber <- input$permanovaPermutationsFac
    metadata <- input$permanovaColumnFac
    column <- meta[[metadata]]
    permanova <- adonis(t(otu) ~ column,
                        data = meta, permutations = permnumber, method = "bray"
    )
    coef <- coefficients(permanova)["column1",]
    top.coef <- coef[rev(order(abs(coef)))[1:20]] #top 20 coefficients
    par(mar = c(3, 14, 2, 1))
     p <- barplot(sort(top.coef), horiz = T, las = 1, main = "Top taxa")
    print(p)
  })
  plot(topFactorPlotParams())
```

### 6.3. Network Plot

The network plot can be used to find relations between samples. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
  netPlotParams()
```
